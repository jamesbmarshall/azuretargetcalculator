<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cloud Target Calculator</title>
  <style>
    /* Page background: gradient */
    body {
      background: linear-gradient(135deg, #0078d4, #74ebd5);
      margin: 0;
      padding: 20px;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      color: #333;
    }
    /* Bubble styling for containers */
    .bubble {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
      padding: 20px;
      position: relative;
    }
    /* Form styling */
    form label {
      display: block;
      margin: 10px 0;
    }
    form input,
    form select {
      width: 100%;
      max-width: 300px;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    form button {
      padding: 10px 20px;
      margin-top: 15px;
      background-color: #01960e;
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      font-size: 16px;
    }
    form button:hover {
      background-color: #5cc0aa;
    }
    /* Advanced Options */
    #advancedToggle {
      background-color: #f68418;
      margin-top: 10px;
    }
    #advancedOptions {
      display: none;
      margin-top: 10px;
    }
    /* Business-style table styling */
    .table-business {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 16px;
    }
    .table-business thead {
      background-color: #2c3e50;
      color: #ecf0f1;
    }
    .table-business th, .table-business td {
      padding: 12px 15px;
      border: 1px solid #ddd;
    }
    .table-business th {
      text-align: left;
    }
    .table-business td {
      text-align: right;
    }
    .table-business tbody tr:nth-child(odd) {
      background-color: #f9f9f9;
    }
    .table-business tbody tr:hover {
      background-color: #f1f1f1;
    }
    /* Hide detailed columns by default */
    .detailRevenue, .detailGrowth, .detailChurn {
      display: none;
    }
    /* When the parent container has "show-details", reveal them */
    .show-details .detailRevenue,
    .show-details .detailGrowth,
    .show-details .detailChurn {
      display: table-cell;
    }
    /* Responsive containers for table and charts */
    .table-responsive, .chart-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    /* Footer styling */
    footer {
      text-align: center;
      padding: 10px;
      color: #fff;
      font-size: 14px;
    }
    /* Mobile responsive adjustments */
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      .bubble {
        padding: 15px;
      }
      form input, form select {
        width: 100%;
      }
      .table-business th, .table-business td {
        font-size: 14px;
      }
    }
    /* Collapsible form styling */
    #calcForm {
      overflow: hidden;
      transition: max-height 0.5s ease;
      max-height: 1000px; /* a high default value */
    }
    #calcForm.collapsed {
      max-height: 0;
    }
    /* Form toggle handle style */
    #formToggleHandle {
      cursor: pointer;
      text-align: center;
      padding: 10px;
      /* Optional: you can uncomment the background-color below if you want a colored handle */
      /* background-color: #2c3e50; */
      color: #2c3e50;
      border-radius: 0 0 10px 10px;
      margin-top: -20px; /* overlap a bit the bottom of the bubble */
    }
    /* Balance Summary styling */
    #balanceSummary {
      margin-bottom: 20px;
      font-size: 18px;
      line-height: 1.5;
    }
    #balanceSummary p {
      margin: 5px 0;
    }
    #balanceSummary hr {
      border: 0;
      border-top: 1px solid #ccc;
      margin: 10px 0;
    }
    .accounting-table {
      width: 30%;
      border-collapse: collapse;
      font-family: Arial, sans-serif;
    }
    .accounting-table td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }
    .accounting-table td.number {
      text-align: right;
    }
    .accounting-table .total-row td {
      font-weight: bold;
    }
    .accounting-table .total-row td.number {
      border-top: 2px solid #000;
    }
  </style>

  <!-- Include Plotly from the CDN for charts -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <!-- Form Bubble -->
  <div class="bubble" id="formContainer">
    <h1>Cloud Target Calculator v2</h1>
    <p>
      Fill in the form below to get insights into the number of customers or the consumption growth you'll need to hit your overall targets.
      You can also use the advanced options to adjust your lead conversion rates.
    </p>
    <form id="calcForm">
      <label>
        Months in Scope:
        <input type="number" id="months" value="12" min="1" step="any" required>
      </label>
      <label>
        Target Spend per Customer, per Month:
        <input type="number" id="targetSpend" value="1000" min="1" step="any" required>
      </label>
      <label>
        Ramp-up Period in Months:
        <input type="number" id="ramp" value="3" min="1" step="any" required>
      </label>
      <label>
        Organic Growth Rate per Month [as %]:
        <input type="number" id="growth" value="1" min="0" step="any" required>
      </label>
      <label>
        Revenue Churn Rate per Month [as %]:
        <input type="number" id="churn" value="1" min="0" step="any" required>
      </label>
      <label>
        Total Revenue Target:
        <input type="number" id="targetRevenue" value="78000" min="1" step="any" required>
      </label>
      <label>
        Baseline Recurring Revenue per Month:
        <input type="number" id="baseline" value="1000" min="0" step="any" required>
      </label>
      <label>
        % of Additional Revenue from New Customers (Acquisition):
        <input type="number" id="pctAcq" value="50" min="0" max="100" step="any" required>
      </label>
      <!-- Seasonality Inputs -->
      <label>
        Plan Start Month:
        <select id="startMonth">
          <option value="0">January</option>
          <option value="1">February</option>
          <option value="2">March</option>
          <option value="3">April</option>
          <option value="4">May</option>
          <option value="5">June</option>
          <option value="6">July</option>
          <option value="7">August</option>
          <option value="8">September</option>
          <option value="9">October</option>
          <option value="10">November</option>
          <option value="11">December</option>
        </select>
      </label>
      <label>
        Plan Start Year:
        <input type="number" id="startYear" value="2025" min="2000" step="1" required>
      </label>
      <label>
        Use Seasonal Adjustments:
        <input type="checkbox" id="seasonalToggle" checked>
      </label>
      
      <!-- Advanced Options Toggle -->
      <button type="button" id="advancedToggle">Advanced Options</button>
      <div id="advancedOptions">
        <label>
          MQLs per SQL:
          <input type="number" id="mqlPerSql" value="5" min="0" step="any">
        </label>
        <label>
          SQLs per Win:
          <input type="number" id="sqlPerWin" value="3" min="0" step="any">
        </label>
      </div>
      <button type="submit">Calculate</button>
    </form>
    <!-- Form Toggle Handle -->
    <div id="formToggleHandle">⬆️ Hide Form</div>
  </div>

  <!-- Results Bubble -->
  <div class="bubble" id="resultsContainer">
    <!-- Toggle Detailed Columns -->
    <button type="button" id="toggleDetails">Show Detailed Columns</button>
    <!-- Container for the dynamic results table -->
    <div class="table-responsive" id="resultsTable"></div>
    <!-- Container for the waterfall chart -->
    <div class="chart-responsive">
      <div id="waterfallChart" style="height: 400px; margin-top: 30px;"></div>
    </div>
  </div>

  <!-- Marketing Funnel Bubble -->
  <div class="bubble" id="funnelContainer">
    <h2>Marketing Funnel</h2>
    <p>
      This is the breakdown of marketing qualified leads, to sales qualified leads, to wins based on a default of 5:3:1,
      or your own conversion if you've changed any advanced options.
    </p>
    <div class="chart-responsive">
      <div id="funnelChart" style="height: 400px; margin-top: 30px;"></div>
    </div>
    <div class="table-responsive" id="funnelTable"></div>
  </div>

  <!-- Footer Section -->
  <footer>
    © 2025 James Marshall. All rights reserved.
  </footer>

  <script>
    // Helper function to format numbers (with commas, 2 decimals).
    function formatNum(num) {
      return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    // Helper function to format currency; negatives are shown as ($X.XX)
    function formatCurrency(num) {
      if (num < 0) {
        return "($" + formatNum(Math.abs(num)) + ")";
      } else {
        return "$" + formatNum(num);
      }
    }
    
    // Update the URL with current form values.
    function updateUrlParams() {
      const params = new URLSearchParams();
      params.set('months', document.getElementById('months').value);
      params.set('targetSpend', document.getElementById('targetSpend').value);
      params.set('ramp', document.getElementById('ramp').value);
      params.set('growth', document.getElementById('growth').value);
      params.set('churn', document.getElementById('churn').value);
      params.set('targetRevenue', document.getElementById('targetRevenue').value);
      params.set('baseline', document.getElementById('baseline').value);
      params.set('pctAcq', document.getElementById('pctAcq').value);
      // Seasonality parameters.
      params.set('startMonth', document.getElementById('startMonth').value);
      params.set('startYear', document.getElementById('startYear').value);
      params.set('seasonal', document.getElementById('seasonalToggle').checked ? "true" : "false");
      // Advanced options:
      params.set('mqlPerSql', document.getElementById('mqlPerSql').value);
      params.set('sqlPerWin', document.getElementById('sqlPerWin').value);

      history.pushState(null, '', '?' + params.toString());
    }
    
    // Toggle Advanced Options.
    document.getElementById('advancedToggle').addEventListener('click', function() {
      const adv = document.getElementById('advancedOptions');
      if (adv.style.display === 'none' || adv.style.display === '') {
        adv.style.display = 'block';
        this.textContent = 'Hide Advanced Options';
      } else {
        adv.style.display = 'none';
        this.textContent = 'Advanced Options';
      }
    });
    
    // Toggle Detailed Columns.
    document.getElementById('toggleDetails').addEventListener('click', function() {
      const tableContainer = document.getElementById('resultsTable');
      if (tableContainer.classList.contains('show-details')) {
        tableContainer.classList.remove('show-details');
        this.textContent = 'Show Detailed Columns';
      } else {
        tableContainer.classList.add('show-details');
        this.textContent = 'Hide Detailed Columns';
      }
    });
    
    // Toggle form visibility with sliding effect.
    const formToggleHandle = document.getElementById('formToggleHandle');
    const calcForm = document.getElementById('calcForm');
    formToggleHandle.addEventListener('click', function() {
      calcForm.classList.toggle('collapsed');
      if (calcForm.classList.contains('collapsed')) {
        formToggleHandle.textContent = "⬇️ Show Form";
      } else {
        formToggleHandle.textContent = "⬆️ Hide Form";
      }
    });
    
    // Pre-populate the form from URL parameters.
    window.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      if (params.toString()) {
        if (params.has('months')) document.getElementById('months').value = params.get('months');
        if (params.has('targetSpend')) document.getElementById('targetSpend').value = params.get('targetSpend');
        if (params.has('ramp')) document.getElementById('ramp').value = params.get('ramp');
        if (params.has('growth')) document.getElementById('growth').value = params.get('growth');
        if (params.has('churn')) document.getElementById('churn').value = params.get('churn');
        if (params.has('targetRevenue')) document.getElementById('targetRevenue').value = params.get('targetRevenue');
        if (params.has('baseline')) document.getElementById('baseline').value = params.get('baseline');
        if (params.has('pctAcq')) document.getElementById('pctAcq').value = params.get('pctAcq');
        if (params.has('startMonth')) document.getElementById('startMonth').value = params.get('startMonth');
        if (params.has('startYear')) document.getElementById('startYear').value = params.get('startYear');
        if (params.has('seasonal')) document.getElementById('seasonalToggle').checked = (params.get('seasonal') === "true");
        if (params.has('mqlPerSql')) document.getElementById('mqlPerSql').value = params.get('mqlPerSql');
        if (params.has('sqlPerWin')) document.getElementById('sqlPerWin').value = params.get('sqlPerWin');

        // If advanced params are present, show advanced section.
        if (params.has('mqlPerSql') || params.has('sqlPerWin')) {
          document.getElementById('advancedOptions').style.display = 'block';
          document.getElementById('advancedToggle').textContent = 'Hide Advanced Options';
        }
        // Auto-trigger the calculation.
        document.getElementById('calcForm').dispatchEvent(new Event('submit'));
      }
    });
    
    // Main calculation logic.
    document.getElementById('calcForm').addEventListener('submit', function(event) {
      event.preventDefault();

      // Read form inputs.
      const n = parseInt(document.getElementById('months').value, 10);
      const s = parseFloat(document.getElementById('targetSpend').value);
      const r = parseInt(document.getElementById('ramp').value, 10);
      const g = parseFloat(document.getElementById('growth').value) / 100;
      const c = parseFloat(document.getElementById('churn').value) / 100;
      const T = parseFloat(document.getElementById('targetRevenue').value);
      const B = parseFloat(document.getElementById('baseline').value);
      const P = parseFloat(document.getElementById('pctAcq').value) / 100;
      
      // Seasonality inputs.
      const startMonth = parseInt(document.getElementById('startMonth').value, 10);
      const startYear = parseInt(document.getElementById('startYear').value, 10);
      const seasonalEnabled = document.getElementById('seasonalToggle').checked;
      const baselineDays = 30;  // baseline for calculations
      const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
      // Adjust February for leap years.
      if (((startYear % 4 === 0) && (startYear % 100 !== 0)) || (startYear % 400 === 0)) {
        daysInMonth[1] = 29;
      }
      
      // Advanced Options.
      const mqlPerSql = parseFloat(document.getElementById('mqlPerSql').value);
      const sqlPerWin = parseFloat(document.getElementById('sqlPerWin').value);

      // Array of month names.
      const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

      // 1) Compute baseline total (growth + churn) with seasonality adjustments.
      let baselineTotal = 0;
      let cumulativeBaselineNoGrowth = 0;
      for (let month = 1; month <= n; month++) {
        let currentMonthIndex = (startMonth + month - 1) % 12;
        let monthFactor = seasonalEnabled ? (daysInMonth[currentMonthIndex] / baselineDays) : 1;
        const baselineMonthRevenue = (B * Math.pow(1 + g, month - 1) * Math.pow(1 - c, month - 1)) * monthFactor;
        baselineTotal += baselineMonthRevenue;
        cumulativeBaselineNoGrowth += (B * Math.pow(1 - c, month - 1)) * monthFactor;
      }

      // 2) Additional revenue from new customers.
      const newRevenueTarget = (T - baselineTotal) * P;

      // 3) Revenue per new customer.
      const effectiveRevenue = (i) => {
        let base = (i <= r) ? s * (i / r) : s * Math.pow(1 + g, i - r);
        return base * Math.pow(1 - c, i - 1);
      };

      // Updated multiplier calculation incorporating seasonality:
      let multiplier = 0;
      for (let m = 1; m <= n; m++) {
        for (let age = 1; age <= n - m + 1; age++) {
          let revenueMonthIndex = (startMonth + m + age - 2) % 12;
          let monthFactor = seasonalEnabled ? (daysInMonth[revenueMonthIndex] / baselineDays) : 1;
          multiplier += effectiveRevenue(age) * monthFactor;
        }
      }
      
      const customersPerMonth = newRevenueTarget / multiplier;

      // Table accumulators.
      let cumulativeNewCustRevenue = 0;
      let cumulativeNewCustNoGrowth = 0;
      let cumulativeNewCustIncrementalGrowth = 0;
      let cumulativeNewCustChurnImpact = 0;
      let cumulativeBaselineIncrementalGrowth = 0;
      let cumulativeBaselineChurnImpact = 0;
      let cumulativeTotalRevenue = 0;
      let runningTotalNewCustomers = 0;

      let tableRows = '';

      // Build the monthly breakdown table.
      for (let month = 1; month <= n; month++) {
        // Determine current calendar month and year.
        let currentMonthIndex = (startMonth + month - 1) % 12;
        let yearOffset = Math.floor((startMonth + month - 1) / 12);
        let currentYear = startYear + yearOffset;
        let currentMonthName = monthNames[currentMonthIndex] + " " + currentYear;
        
        let monthFactor = seasonalEnabled ? (daysInMonth[currentMonthIndex] / baselineDays) : 1;
        
        const newCustomers = customersPerMonth;
        runningTotalNewCustomers += newCustomers;

        let newCustMonthRevenue = 0;
        let newCustMonthNoGrowth = 0;
        let newCustMonthIncrementalGrowth = 0;
        let newCustMonthChurnImpact = 0;

        for (let age = 1; age <= month; age++) {
          const baseRevenue = (age <= r) ? s * (age / r) : s * Math.pow(1 + g, age - r);
          const effRev = baseRevenue * Math.pow(1 - c, age - 1);
          const noGrowth = (age <= r) ? s * (age / r) : s;
          const effNoGrowth = noGrowth * Math.pow(1 - c, age - 1);
          const incRevenue = effRev - effNoGrowth;
          const churnLoss = baseRevenue - effRev;

          newCustMonthRevenue += newCustomers * effRev;
          newCustMonthNoGrowth += newCustomers * effNoGrowth;
          newCustMonthIncrementalGrowth += newCustomers * incRevenue;
          newCustMonthChurnImpact += newCustomers * churnLoss;
        }
        // Apply seasonality.
        newCustMonthRevenue *= monthFactor;
        newCustMonthNoGrowth *= monthFactor;
        newCustMonthIncrementalGrowth *= monthFactor;
        newCustMonthChurnImpact *= monthFactor;

        // Baseline revenue.
        const baselineMonthRevenue = (B * Math.pow(1 + g, month - 1) * Math.pow(1 - c, month - 1)) * monthFactor;
        const baselineMonthNoGrowth = (B * Math.pow(1 - c, month - 1)) * monthFactor;
        const baselineMonthIncrementalGrowth = baselineMonthRevenue - baselineMonthNoGrowth;
        const baselineMonthChurnImpact = ((B * Math.pow(1 + g, month - 1)) - (B * Math.pow(1 + g, month - 1) * Math.pow(1 - c, month - 1))) * monthFactor;

        cumulativeNewCustRevenue += newCustMonthRevenue;
        cumulativeNewCustNoGrowth += newCustMonthNoGrowth;
        cumulativeNewCustIncrementalGrowth += newCustMonthIncrementalGrowth;
        cumulativeNewCustChurnImpact += newCustMonthChurnImpact;
        cumulativeBaselineIncrementalGrowth += baselineMonthIncrementalGrowth;
        cumulativeBaselineChurnImpact += baselineMonthChurnImpact;
        cumulativeTotalRevenue += (newCustMonthRevenue + baselineMonthRevenue);

        tableRows += `
          <tr>
            <td style="text-align:left;">${currentMonthName}</td>
            <td>${formatNum(newCustomers)}</td>
            <td>${formatNum(runningTotalNewCustomers)}</td>
            <td class="detailRevenue">$${formatNum(newCustMonthRevenue)}</td>
            <td class="detailRevenue">$${formatNum(baselineMonthRevenue)}</td>
            <td>$${formatNum(newCustMonthRevenue + baselineMonthRevenue)}</td>
            <td class="detailGrowth">$${formatNum(newCustMonthIncrementalGrowth)}</td>
            <td class="detailGrowth">$${formatNum(baselineMonthIncrementalGrowth)}</td>
            <td>$${formatNum(newCustMonthIncrementalGrowth + baselineMonthIncrementalGrowth)}</td>
            <td class="detailChurn">${formatCurrency(-newCustMonthChurnImpact)}</td>
            <td class="detailChurn">${formatCurrency(-baselineMonthChurnImpact)}</td>
            <td>${formatCurrency(-(newCustMonthChurnImpact + baselineMonthChurnImpact))}</td>
            <td>$${formatNum(cumulativeTotalRevenue)}</td>
          </tr>
        `;
      }

      // Build the results HTML with an added balance summary.
      // We group the revenue into two items:
      //   Existing Business Revenue = T - newRevenueTarget
      //   New Customer Revenue = newRevenueTarget
      // Their sum equals the total revenue target T.
      const resultsHTML = `
        <h2>Results</h2>
        <p>
          The baseline revenue over the ${n}-month period, accounting for ${seasonalEnabled ? "seasonality, growth & churn" : "growth & churn"}, is $${formatNum(baselineTotal)}. 
          To achieve the desired in-year revenue, an additional $${formatNum(newRevenueTarget)} must come from new customers, and $${formatNum(T - newRevenueTarget - baselineTotal)} from growing existing customers.
          This plan requires attracting ${formatNum(customersPerMonth)} new customers per month, or a total of ${formatNum(customersPerMonth * n)} over the period.
        </p>
        <div id="balanceSummary">
          <table class="accounting-table">
            <tr>
              <td>Baseline</td>
              <td class="number">$${formatNum(baselineTotal)}</td>
            </tr>
            <tr>
              <td>New Customer Revenue</td>
              <td class="number">$${formatNum(newRevenueTarget)}</td>
            </tr>
            <tr>
              <td>Proactive Growth Revenue</td>
              <td class="number">$${formatNum(T - newRevenueTarget - baselineTotal)}</td>
            </tr>
            <tr class="total-row">
              <td>Total</td>
              <td class="number">$${formatNum(baselineTotal + newRevenueTarget + (T - newRevenueTarget - baselineTotal))}</td>
            </tr>
          </table>
        </div>
        <h3>Baseline + Customer Adds Breakdown</h3>
        <div class="table-responsive">
          <table class="table-business">
            <thead>
              <tr>
                <th>Month</th>
                <th>New Cust. Added</th>
                <th>Running Total New Cust.</th>
                <th class="detailRevenue">New Cust. Revenue</th>
                <th class="detailRevenue">Baseline Revenue</th>
                <th>Total Monthly Revenue</th>
                <th class="detailGrowth">New Cust. Organic Growth</th>
                <th class="detailGrowth">Baseline Organic Growth</th>
                <th>Total Organic Growth</th>
                <th class="detailChurn">New Cust. Churn</th>
                <th class="detailChurn">Baseline Churn</th>
                <th>Total Churn</th>
                <th>Cumulative Total Revenue</th>
              </tr>
            </thead>
            <tbody>
              ${tableRows}
            </tbody>
          </table>
        </div>
      `;
      document.getElementById('resultsTable').innerHTML = resultsHTML;
      
      // --------------------------------------------------------------------
      // Build the Proactive Growth Target Breakdown Table.
      const proactiveGrowthTarget = T - newRevenueTarget - baselineTotal;
      const divisions = (n * n + n) / 2;
      const dividedGrowthTarget = proactiveGrowthTarget / divisions;
      let proactiveTableRows = '';
      let cumulativeProactive = 0;
      for (let month = 1; month <= n; month++) {
          let currentMonthIndex = (startMonth + month - 1) % 12;
          let yearOffset = Math.floor((startMonth + month - 1) / 12);
          let currentYear = startYear + yearOffset;
          let currentMonthName = monthNames[currentMonthIndex] + " " + currentYear;
          const monthlyTarget = month * dividedGrowthTarget;
          cumulativeProactive += monthlyTarget;
          proactiveTableRows += `
            <tr>
              <td style="text-align:left;">${currentMonthName}</td>
              <td>$${formatNum(monthlyTarget)}</td>
              <td>$${formatNum(cumulativeProactive)}</td>
            </tr>
          `;
      }
      const proactiveTableHTML = `
        <h3>Proactive Growth Target Breakdown</h3>
        <p>
          This table breaks down the proactive growth target (revenue required from growing existing customers) across the months.
          The monthly target is determined by dividing the total proactive target by ((months² + months)/2) and multiplying by the month number.
        </p>
        <div class="table-responsive">
          <table class="table-business">
            <thead>
              <tr>
                <th>Month</th>
                <th>Monthly Proactive Growth Target</th>
                <th>Cumulative Proactive Growth Target</th>
              </tr>
            </thead>
            <tbody>
              ${proactiveTableRows}
            </tbody>
          </table>
        </div>
      `;
      document.getElementById('resultsTable').innerHTML += proactiveTableHTML;

      // Update URL parameters.
      updateUrlParams();

      // --------------------------------------------------------------------
      // Build the Plotly Waterfall Chart.
      const step1 = cumulativeBaselineNoGrowth + cumulativeBaselineChurnImpact;
      const step2 = cumulativeBaselineIncrementalGrowth;
      const step3 = -cumulativeBaselineChurnImpact;
      const step4 = cumulativeNewCustNoGrowth + cumulativeNewCustChurnImpact;
      const step5 = cumulativeNewCustIncrementalGrowth;
      const step6 = -cumulativeNewCustChurnImpact;
      const step7 = T - newRevenueTarget - baselineTotal;
      const finalTotal = step1 + step2 + step3 + step4 + step5 + step6 + step7;

      const waterfallData = [{
        type: 'waterfall',
        orientation: "v",
        measure: ['absolute','relative','relative','relative','relative','relative','relative','total'],
        x: [
          ["Baseline", "Baseline", "Baseline", "Acquisition", "Acquisition", "Acquisition", "Growth", "Target"],
          ['Baseline', 'Organic Growth', 'Churn of Baseline', 'Customer Adds', 'Adds Organic Growth', 'Churn of Adds', 'Proactive', 'Final Total']
        ],
        y: [step1, step2, step3, step4, step5, step6, step7, finalTotal],
        text: [
          '$' + formatNum(step1),
          '$' + formatNum(step2),
          '$' + formatNum(Math.abs(step3)),
          '$' + formatNum(step4),
          '$' + formatNum(step5),
          '$' + formatNum(Math.abs(step6)),
          '$' + formatNum(step7),
          '$' + formatNum(finalTotal)
        ],
        textposition: 'outside',
        cliponaxis: false,
        connector: { line: { color: 'rgb(63, 63, 63)' } }
      }];

      const layout = {
        title: 'Revenue Waterfall Chart',
        waterfallgap: 0.3,
        yaxis: { title: 'Revenue' },
        autosize: true
      };

      Plotly.newPlot('waterfallChart', waterfallData, layout);

      // --------------------------------------------------------------------
      // Build the Marketing Funnel Chart.
      const wins = runningTotalNewCustomers;
      const sqls = wins * sqlPerWin;
      const mqls = sqls * mqlPerSql;
      
      const funnelData = [{
        type: 'funnel',
        y: ['MQLs', 'SQLs', 'Wins'],
        x: [mqls, sqls, wins],
        textinfo: "value+percent initial"
      }];
      
      const funnelLayout = {
        title: 'Marketing Funnel',
        margin: { l: 150 },
        autosize: true
      };
      
      Plotly.newPlot('funnelChart', funnelData, funnelLayout);
    });
  </script>
</body>
</html>